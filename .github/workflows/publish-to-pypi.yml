# ./.github/workflows/publish-to-pypi.yml
name: Build and publish Python distributions to PyPI

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  prepare:
    name: получение версии релиза
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: проверка репозитория
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: определение строки с версией
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            echo "активируется при отправке тега, используется версия из тега: $VERSION"
          else
            echo "запущено вручную, поиск последнего тега в git..."
            VERSION=$(git describe --tags --abbrev=0)
            echo "найден последний тег: $VERSION"
          fi
          CLEAN_VERSION=${VERSION#v}
          echo "очищенная версия: $CLEAN_VERSION"
          echo "version=$CLEAN_VERSION" >> "$GITHUB_OUTPUT"

  build-wheels-manylinux:
    name: сборка под manylinux
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: проверка репозитория
        uses: actions/checkout@v5

      - name: сборка в контейнере manylinux
        env:
          PACKAGE_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          docker run --rm \
            -v "$(pwd)":/workdir \
            -e PACKAGE_VERSION \
            quay.io/pypa/manylinux2014_x86_64 /bin/bash -c '
              set -eux
              
              echo "--- установка версии в pyproject.toml на $PACKAGE_VERSION ---"
              sed -i "s/^version = .*/version = \"$PACKAGE_VERSION\"/" /workdir/python/pyproject.toml
              
              echo "--- установка Go ---"
              yum install -y curl
              curl -sL https://go.dev/dl/go1.25.0.linux-amd64.tar.gz | tar -C /usr/local -xzf -
              export PATH=$PATH:/usr/local/go/bin
              
              echo "--- установка uv ---"
              # Используем cp310 как "хост" для сборки uv
              /opt/python/cp310-cp310/bin/pip install uv
              
              mkdir -p /workdir/dist
              
              echo "--- сборка wheel (с тегом cp310-cp310) ---"
              CGO_ENABLED=1 TARGET_ARCH="x86_64" \
              /opt/python/cp310-cp310/bin/uv build \
                --wheel \
                --python "/opt/python/cp310-cp310/bin/python" \
                --out-dir /workdir/dist \
                --package py-fake-useragent \
                /workdir/python

              echo "--- исправление билдов с auditwheel ---"
              # auditwheel возьмет cp310-cp310 wheel, отремонтирует, заменит platform tag
              # и удалит исходный файл. Результат будет в /workdir/dist, все еще с cp310-cp310.
              cd /workdir/dist
              # Находим wheel, который uv только что собрал
              ORIG_WHL=$(ls py_fake_useragent-*-cp310-cp310-linux_x86_64.whl 2>/dev/null | head -n 1)

              if [ -z "$ORIG_WHL" ]; then
                echo "Ошибка: Исходный wheel-файл с тегом cp310-cp310-linux_x86_64.whl не найден."
                exit 1
              fi
              
              auditwheel repair "$ORIG_WHL" --plat manylinux2014_x86_64 -w /workdir/dist/
              
              echo "--- переименование в ABI-agnostic (py3-none) ---"
              # Теперь переименовываем Python-тег в отремонтированном wheel-файле
              for whl_file in py_fake_useragent-*-cp310-cp310-manylinux*.whl; do
                if [ -f "$whl_file" ]; then
                  NEW_NAME=$(echo "$whl_file" | sed 's/-cp310-cp310-/-py3-none-/g')
                  mv "$whl_file" "$NEW_NAME"
                  echo "Переименован: $whl_file -> $NEW_NAME"
                else
                  echo "Предупреждение: Wheel-файл $whl_file не найден для переименования."
                fi
              done

              echo "--- готовые билды в dist/ ---"
              ls -l /workdir/dist/
            '
      
      - name: сохрание пакетов
        uses: actions/upload-artifact@v4
        with:
          name: python-package-wheel-manylinux
          path: dist/*.whl

  build-wheels-musllinux:
    name: сборка под musllinux
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: проверка репозитория
        uses: actions/checkout@v4

      - name: сборка в контейнере musllinux
        env:
          PACKAGE_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          docker run --rm \
            -v "$(pwd)":/workdir \
            -e PACKAGE_VERSION \
            quay.io/pypa/musllinux_1_1_x86_64 /bin/bash -c '
              set -eux
              
              echo "--- установка версии в pyproject.toml ---"
              sed -i "s/^version = .*/version = \"$PACKAGE_VERSION\"/" /workdir/python/pyproject.toml
              
              echo "--- установка Go ---"
              apk add --no-cache curl build-base
              curl -sL https://go.dev/dl/go1.25.0.linux-amd64.tar.gz | tar -C /usr/local -xzf -
              export PATH=$PATH:/usr/local/go/bin
              
              echo "--- установка uv ---"
              /opt/python/cp310-cp310/bin/pip install uv
              
              mkdir -p /workdir/dist
              
              echo "--- сборка wheel (с тегом cp310-cp310) ---"
              CGO_ENABLED=1 TARGET_ARCH="x86_64" \
              /opt/python/cp310-cp310/bin/uv build \
                --wheel \
                --python "/opt/python/cp310-cp310/bin/python" \
                --out-dir /workdir/dist \
                --package py-fake-useragent \
                /workdir/python

              echo "--- исправление билдов с auditwheel ---"
              cd /workdir/dist
              ORIG_WHL=$(ls py_fake_useragent-*-cp310-cp310-linux_x86_64.whl 2>/dev/null | head -n 1)

              if [ -z "$ORIG_WHL" ]; then
                echo "Ошибка: Исходный wheel-файл с тегом cp310-cp310-linux_x86_64.whl не найден."
                exit 1
              fi

              auditwheel repair "$ORIG_WHL" --plat musllinux_1_1_x86_64 -w /workdir/dist/
              
              echo "--- переименование в ABI-agnostic (py3-none) ---"
              for whl_file in py_fake_useragent-*-cp310-cp310-musllinux*.whl; do
                if [ -f "$whl_file" ]; then
                  NEW_NAME=$(echo "$whl_file" | sed 's/-cp310-cp310-/-py3-none-/g')
                  mv "$whl_file" "$NEW_NAME"
                  echo "Переименован: $whl_file -> $NEW_NAME"
                else
                  echo "Предупреждение: Wheel-файл $whl_file не найден для переименования."
                fi
              done

              echo "--- готовые билды в dist/ ---"
              ls -l /workdir/dist/
            '
      
      - name: сохранение пакетов
        uses: actions/upload-artifact@v4
        with:
          name: python-package-wheel-musllinux
          path: dist/*.whl

  build-wheels-other:
    name: сборка под ${{ matrix.platform.plat }}
    needs: prepare
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            plat: win_amd64
            arch: amd64
          - os: macos-13
            plat: macosx_x86_64
            arch: x86_64
          - os: macos-14
            plat: macosx_arm64
            arch: arm64
    steps:
      - name: проверка репозитория
        uses: actions/checkout@v4

      - name: установка версии в pyproject.toml
        shell: python
        env:
          PYTHONUTF8: 1
          PYTHONIOENCODING: 'UTF-8'
        run: |
          import re
          from pathlib import Path
          version = "${{ needs.prepare.outputs.version }}"
          pyproject_path = Path("python/pyproject.toml")
          content = pyproject_path.read_text(encoding="utf-8")
          new_content = re.sub(r'^version\s*=\s*".*"', f'version = "{version}"', content, count=1, flags=re.MULTILINE)
          pyproject_path.write_text(new_content, encoding="utf-8")

      - name: установка Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          
      - name: установка uv
        run: pip install uv
        
      - name: сборка wheel (с конкретным тегом Python)
        env:
          PYTHONUTF8: 1
          PYTHONIOENCODING: 'UTF-8'
        working-directory: ./python
        shell: bash
        run: |
          mkdir -p ../dist
          ARCH="${{ matrix.platform.arch }}"
          
          echo "--- сборка под $ARCH ---"
          # uv будет использовать текущую версию Python ранера (напр. cp310-cp310)
          CGO_ENABLED=1 TARGET_ARCH="$ARCH" uv build --wheel --out-dir ../dist --package py-fake-useragent

          echo "--- переименование в ABI-agnostic (py3-none) ---"
          cd ../dist
          ls -l
          
          # Переименовываем wheel-файл, чтобы заменить python-tag на py3-none
          python -c "import os, sys, re; \
            for name in os.listdir('.'): \
                if name.endswith('.whl'): \
                    # Это regex заменяет любую комбинацию -cpXXX-cpXXX-, -cpXXX-abi3- или -cpXXX-none- на -py3-none- \
                    new_name = re.sub(r'-(cp\d+|py\d+)-(cp\d+|abi3|none)-', '-py3-none-', name); \
                    if name != new_name: \
                        print(f'Переименовывается: {name} -> {new_name}'); \
                        os.rename(name, new_name); \
                    else: \
                        print(f'Переименование не требуется для: {name}');"
          
          echo "--- итоговые файлы ---"
          ls -l

      - name: сохранение пакетов
        uses: actions/upload-artifact@v4
        with:
          name: python-package-wheel-${{ matrix.platform.plat }}
          path: dist/*.whl

  publish-to-pypi:
    name: выгрузка и опубликование пакетов на PyPI
    needs: [prepare, build-wheels-manylinux, build-wheels-musllinux, build-wheels-other]
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags')) || github.event_name == 'workflow_dispatch'
    steps:
      - name: скачивание всех сборок пакетов
        uses: actions/download-artifact@v4
        with:
          pattern: python-package-wheel-*
          path: dist
          merge-multiple: true
      - name: список сборок
        run: ls -R dist
      - name: публикация на PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
